{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar | Assignment Tracker</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <nav>
        <a href="{% url 'dashboard_page' %}">Dashboard</a>
        <a href="{% url 'calendar_page' %}">Calendar</a>
        <a href="{% url 'profile_page' %}">Profile</a>
        <a href="#" onclick="logout()">Logout</a>
    </nav>
    <main>
        <h1>Assignments Calendar</h1>
        <div class="calendar-container">
            <div id="calendar-header">
                <button onclick="prevMonth()">&#8592;</button>
                <h2 id="month-year"></h2>
                <button onclick="nextMonth()">&#8594;</button>
            </div>
            <div id="calendar-days">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <div id="calendar-grid"></div>
        </div>

    </main>
    <script src="{% static 'js/script.js' %}"></script>
    
    <script>
        const monthNames = ["January", "February", "March", "April", "May", "June",
                        "July", "August", "September", "October", "November", "December"];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        
        async function loadCalendar() {
            const token = getToken();
            let assignments = [];

            try {
                const res = await fetch(`${API_BASE}/assignments/`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!res.ok) {
                    console.warn("Failed to load assignments:", res.status);
                } else {
                    assignments = await res.json();
                    if (!Array.isArray(assignments)) {
                        console.warn("Unexpected response format:", assignments);
                        assignments = [];
                    }
                }
            } catch (error) {
                console.error("Error fetching assignments:", error);
            }

            renderCalendar(assignments);
        }



        function renderCalendar(assignments) {
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();

            const grid = document.getElementById("calendar-grid");
            const header = document.getElementById("month-year");
            grid.innerHTML = "";
            header.innerText = `${monthNames[currentMonth]} ${currentYear}`;

            for (let i = 0; i < startDay; i++) {
                grid.innerHTML += `<div></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const fullDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let assignmentHTML = "";
                assignments.forEach(a => {
                    if (a.deadline === fullDate) {
                        assignmentHTML += `<span class="deadline">${a.name}</span>`;
                    }
                });
                grid.innerHTML += `<div class="calendar-day"><span>${day}</span>${assignmentHTML}</div>`;
            }
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            loadCalendar();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            loadCalendar();
        }

        document.addEventListener("DOMContentLoaded", loadCalendar);
    </script>
</body>
</html>
